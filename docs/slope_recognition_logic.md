# 슬로프 인식 알고리즘 및 특이사항 기록

이 문서는 Snow Record 앱의 슬로프 인식 엔진 로직과 특정 슬로프(ZEUS II)의 좌표 분석 결과를 기록합니다.

## 1. 슬로프 인식 알고리즘 (Slope Recognition Logic)

### A. 기본 원리
GPS 좌표가 슬로프의 **다각형(Polygon)** 내부에 포함되는지를 `Ray Casting` 알고리즘으로 1차 판별합니다. 그러나 슬로프가 겹치거나 인접한 경우(교차로, 합류 지점 등) 단순 포함 여부만으로는 정확한 판별이 어렵습니다. 이를 보완하기 위해 **Dwell Time(체류 시간)**과 **Start/Finish(시작/종료) 게이트** 로직을 사용합니다.

### B. 중복 인식 해결 (Dwell Time Logic)
- **개념:** 사용자가 런(Run) 중에 실제로 가장 오래 머물러 있었던 슬로프를 '주행한 슬로프'로 판단합니다.
- **로직:**
    1. `RIDING` 상태에서 매초 GPS 좌표를 수집할 때마다, 해당 좌표가 포함된 모든 슬로프의 '방문 횟수(Counter)'를 증가시킵니다.
    2. 런이 종료(`RESTING` 전환)되면, 방문 횟수가 가장 높은 슬로프를 1순위 후보로 선정합니다.
    3. **노이즈 필터링:** 최대 방문 횟수의 10% 미만인 슬로프(잠깐 스쳐 지나간 경우)는 후보에서 제외합니다.
    4. **우선순위:** 방문 횟수가 비슷할 경우, `면적이 더 작은 슬로프`(더 구체적인 경로)를 우선합니다.

### C. 시작점/도착점 자동 산출 (Start/Finish Point Derivation)
- **목적:** 슬로프의 시작(Top)과 끝(Bottom)을 통과했는지를 확인하여 '완주 여부'를 판단하기 위함.
- **알고리즘 (Altitude-based Logic):**
    1.  **데이터 전처리:** 슬로프 경계 폴리곤의 모든 좌표에 대해 **해발고도(Elevation)** 데이터를 조회합니다.
    2.  **Top Point (시작점):** 경계 좌표 중 **해발고도가 가장 높은 지점**을 시작점으로 정의합니다.
    3.  **Bottom Point (종료점):** 경계 좌표 중 **해발고도가 가장 낮은 지점**을 종료점으로 정의합니다.
    4.  **장점:** 물리적인 중력 방향과 100% 일치하므로 별도의 수동 보정 없이도 정확한 주행 방향(Top -> Bottom)을 판별할 수 있습니다. S자형이나 복잡한 형태의 슬로프에서도 오동작하지 않습니다.

---

## 2. 케이스 스터디: 제우스 2 (ZEUS II) 개선 결과

### A. 기존 문제 상황 (장축 로직)
- **이슈:** 중간에 크게 굽이치는 'S자' 구간으로 인해 기하학적 장축의 끝점이 실제 출발점과 약 192m 오차 발생.
- **결과:** 실제 출발점이 아닌 슬로프 중간 지점이 Start Point로 잡히는 문제.

### B. 고도 기반 로직 적용 결과 (2026-01-23 완료)
- **Start Point:** Index 0 (해발 1337m) - 물리적 최상단
- **Finish Point:** Index 47 부근 (해발 1036m) - 물리적 최하단
- **결과:** Open-Elevation API 데이터를 기반으로 정확한 Start/Finish Point가 설정됨.

---

## 3. 진행률(Progress) 및 고도차(Vertical Drop) 계산

사용자의 현재 위치를 $P_{current}$, 시작점을 $P_{top}$, 종료점을 $P_{bottom}$이라 할 때:

### A. 고도차 (Vertical Drop)
- `Vertical Drop` = $Alt_{top} - Alt_{bottom}$
- 슬로프의 공식적인 제원과 일치하는 수직 낙하 높이입니다.

### B. 진행률 (Progress)
- **계산식:** $Progress(\%) = \frac{Alt_{top} - Alt_{current}}{Alt_{top} - Alt_{bottom}} \times 100$
- **특징:** 수평 거리가 아닌 **고도 변화**를 기준으로 진행률을 표시하여, 활강 스포츠의 특성을 더 잘 반영합니다.

